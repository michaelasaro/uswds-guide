# ============================================================================
# Deploy to GitHub Pages
# ============================================================================
#
# This workflow automatically builds and deploys the Civic Design System
# documentation site to GitHub Pages whenever changes are pushed to main.
#
# How it works:
#   1. Checks out the code and installs dependencies
#   2. Runs the full build (Sass compilation, asset copying, etc.)
#   3. Rewrites asset paths so they work on GitHub Pages (see note below)
#   4. Uploads the built site and deploys it
#
# Path rewriting:
#   GitHub Pages serves this site at: michaelasaro.github.io/civic-guide/
#   But locally, the site runs at localhost:3001/ (no subpath).
#   All source files use root-relative paths like /civic/styles/civic.css
#   which works locally but breaks on GitHub Pages because the browser
#   would look for michaelasaro.github.io/civic/styles/civic.css instead
#   of michaelasaro.github.io/civic-guide/civic/styles/civic.css.
#
#   The "Rewrite paths" step fixes this by adding /civic-guide/ to all
#   asset paths in the built output. Source files are never modified.
#
# To trigger manually:
#   Go to Actions > "Deploy to GitHub Pages" > "Run workflow"
#
# ============================================================================

name: Deploy to GitHub Pages

# Run this workflow when code is pushed to main, or when triggered manually
on:
  push:
    branches: [main]
  workflow_dispatch:

# Grant the workflow permission to read code and write to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Only allow one deployment at a time (don't queue up multiple deploys)
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:

  # ---- Build Job ----
  # Compiles the site and prepares it for deployment
  build:
    runs-on: ubuntu-latest
    steps:

      # Pull down the repository code
      - name: Checkout
        uses: actions/checkout@v4

      # Install Node.js (needed for Sass compilation and the build tools)
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # Install project dependencies from package-lock.json
      - name: Install dependencies
        run: npm ci

      # Run the full build: compile Sass, copy USWDS assets, etc.
      # Output goes to the dist/ folder
      - name: Build
        run: npm run build

      # Fix asset paths for GitHub Pages
      # Source files use paths like /civic/ and /site/ which work on localhost.
      # On GitHub Pages the site lives at /civic-guide/, so we prefix all paths.
      - name: Rewrite paths for GitHub Pages
        run: |
          REPO_NAME="civic-guide"

          # HTML: prefix /civic/, /uswds/, /site/ paths and fix root hrefs
          find dist -name '*.html' -exec sed -i \
            -e "s|=\"/civic/|=\"/${REPO_NAME}/civic/|g" \
            -e "s|=\"/uswds/|=\"/${REPO_NAME}/uswds/|g" \
            -e "s|=\"/site/|=\"/${REPO_NAME}/site/|g" \
            -e "s|href=\"/\"|href=\"/${REPO_NAME}/\"|g" \
            -e "s|href=\"/\" |href=\"/${REPO_NAME}/\" |g" \
            {} +

          # JS: fix paths in scripts (e.g., search.js redirect URL)
          find dist -name '*.js' -exec sed -i \
            -e "s|\"/civic/|\"/${REPO_NAME}/civic/|g" \
            -e "s|\"/uswds/|\"/${REPO_NAME}/uswds/|g" \
            -e "s|\"/site/|\"/${REPO_NAME}/site/|g" \
            {} +

          # CSS: font URLs are compiled as url(/dist/uswds/fonts/...) but on
          # GitHub Pages dist/ IS the root, so strip /dist and add repo prefix
          find dist -name '*.css' -exec sed -i \
            -e "s|url(/dist/|url(/${REPO_NAME}/|g" \
            {} +

      # Configure GitHub Pages settings
      - name: Setup Pages
        uses: actions/configure-pages@v4

      # Package the dist/ folder as a GitHub Pages artifact
      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: './dist'

  # ---- Deploy Job ----
  # Publishes the built site to GitHub Pages
  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build    # Wait for the build job to finish first
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
